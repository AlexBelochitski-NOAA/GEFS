#!/bin/ksh 
#####################################################################
# 9/20/2009, Julia Zhu   Scripts are modified to be sharable
#                        between EMC and NCO
#         Please note that variable "RUN_ENVIR" is set and used
#         in the development enviroment only.
# 3/27/2015 Dingchen Hou, Vertical structure and WCOSS phase 2 statndard
######################################################################

echo `date` $0 `date -u` begin

set -xa
na=`basename $0`
export PS4=' + $SECONDS $na $LINENO: '
date

###########################################
# Run gefs_config to get input parameters
###########################################
if [ "$RUN_ENVIR" = dev ]      ### For Developers
then
# . $basesource/nw${envir}/versions/gefs.ver
  . $basesource/nwdev/parm/gefs_config
fi

####################################
# obtain unique process id (pid) and make temp directory
####################################
export pid=$$
export DATAROOT=${DATAROOT:-/tmpnwprd_p2}
export DATA=${DATA:-$DATAROOT/${job}.${pid}}
mkdir -p $DATA
cd $DATA

######################################
# Set up the cycle variable
######################################
export cycle=t${cyc}z

####################################
# Specify NET and RUN Name and model
####################################
export NET=${NET:-gens}
export RUN=gefs

####################################
# File To Log Msgs
####################################
export jlogfile=${jlogfile:-$COMROOT/logs/jlogfiles/jlogfile.${job}.${pid}}

####################################
# Determine Job Output Name on System
####################################
export outid="LL$job"
export jobid="${outid}.o${pid}"
export pgmout="OUTPUT.${pid}"
export pgmerr=errfile

####################################
# SENDCOM  - Copy Files From TMPDIR to $COMOUT
# SENDDBN  - Issue DBNet Client Calls
####################################
  export SENDCOM=${SENDCOM:-YES}
  export SENDDBN=${SENDDBN:-YES}

##############################
# Run setup to initialize working directory and utility scripts
##############################
#sh setup.sh

##############################
# Run setpdy and initialize PDY variables
##############################
sh setpdy.sh
. PDY

##############################################
# Define COM directories
##############################################
export COMIN=$COMROOT/${NET}/${envir}/gefs.${PDY}
export COMOUT=$COMROOT/${NET}/${envir}/gefs.${PDY}

##############################################
echo set parameters using gefs.parm
##############################################
. $PARMgefs/gefs.parm

case $cyc in
  00) export fhmax=$fhmax00;;
  06) export fhmax=$fhmax06;;
  12) export fhmax=$fhmax12;;
  18) export fhmax=$fhmax18;;
esac

####################################
# Create member list
####################################
memberlist=""

(( imem = 0 ))
while (( imem < npair * 2 ))
do
  (( imem = imem + 1 ))
  if (( imem < 10 )); then
    imem=0$imem
  fi
  memberlist="$memberlist p$imem"
done
echo memberlist=$memberlist

echo
env | sort
echo

# Test GRIB files before cleaning up
echo `date` GRIB file test before cleanup begin
(( nmissing = 0 ))
for cyc_check in 00 06 12 18
do

  echo cyc=$cyc cyc_check=$cyc_check

  if (( cyc == cyc_check )); then
    export fcstlong=true
    export cfsuffix=""
    export cycsuffix=false
    memberlisttest="$memberlist c00"
  else
    export fcstlong=false
    export cfsuffix=".cycfs$cyc_check"
    export cycsuffix=true
    memberlisttest="$memberlist"
  fi

  for member in $memberlisttest
  do

    ####################################
    # Specify the Ensemble Member
    ####################################
    export RUN=ge${member}

    export PS4=' + $SECONDS $na $RUN R $LINENO: '

    ####################################
    # Specify Forecast Hour Range
    ####################################
    export FHINC=06

    export SHOUR=00

    filelist="\
      $COMIN/$cyc/master/ge$member.$cycle.master.grbanl$cfsuffix \
      $COMIN/$cyc/master/ge$member.$cycle.master.grbianl$cfsuffix \
      $COMIN/$cyc/pgrb2a/ge$member.$cycle.pgrb2aanl$cfsuffix \
      $COMIN/$cyc/pgrb2a/ge$member.$cycle.pgrb2aanl$cfsuffix.idx \
      $COMIN/$cyc/pgrb2ap5/ge$member.$cycle.pgrb2a.0p50.anl$cfsuffix \
      $COMIN/$cyc/pgrb2ap5/ge$member.$cycle.pgrb2a.0p50.anl$cfsuffix.idx \
      $COMIN/$cyc/pgrb2b/ge$member.$cycle.pgrb2banl$cfsuffix \
      $COMIN/$cyc/pgrb2b/ge$member.$cycle.pgrb2banl$cfsuffix.idx \
      $COMIN/$cyc/pgrb2bp5/ge$member.$cycle.pgrb2b.0p50.anl$cfsuffix \
      $COMIN/$cyc/pgrb2bp5/ge$member.$cycle.pgrb2b.0p50.anl$cfsuffix.idx \
    "
    for file in $filelist
    do
      if [[ ! -s $file ]]; then
	(( nmissing = nmissing + 1 ))
	echo nmissing=$nmissing file=$file IS MISSING
      fi
    done

    if [[ $fcstlong = true ]]; then
      export FHOUR=$fhmax
      if (( FHOUR < 10 )); then
	FHOUR=0$FHOUR
      fi
      export FHOUR
    else
      export FHOUR=06
    fi

    FH=$SHOUR
    while (( FH <= FHOUR ))
    do
      filelist="\
	$COMIN/$cyc/master/ge$member.$cycle.master.grbf$FH$cfsuffix \
	$COMIN/$cyc/master/ge$member.$cycle.master.grbif$FH$cfsuffix \
	$COMIN/$cyc/pgrb2a/ge$member.$cycle.pgrb2af$FH$cfsuffix \
	$COMIN/$cyc/pgrb2a/ge$member.$cycle.pgrb2af$FH$cfsuffix.idx \
	$COMIN/$cyc/pgrb2ap5/ge$member.$cycle.pgrb2a.0p50.f$FH$cfsuffix \
	$COMIN/$cyc/pgrb2ap5/ge$member.$cycle.pgrb2a.0p50.f$FH$cfsuffix.idx \
	$COMIN/$cyc/pgrb2b/ge$member.$cycle.pgrb2bf$FH$cfsuffix \
	$COMIN/$cyc/pgrb2b/ge$member.$cycle.pgrb2bf$FH$cfsuffix.idx \
	$COMIN/$cyc/pgrb2bp5/ge$member.$cycle.pgrb2b.0p50.f$FH$cfsuffix \
	$COMIN/$cyc/pgrb2bp5/ge$member.$cycle.pgrb2b.0p50.f$FH$cfsuffix.idx \
	$COMIN/$cyc/pgrb2alr/ge$member.$cycle.pgrb2af$FH.2$cfsuffix \
	$COMIN/$cyc/pgrb2alr/ge$member.$cycle.pgrb2af$FH.2$cfsuffix.idx \
	$COMIN/$cyc/pgrb2blr/ge$member.$cycle.pgrb2bf$FH.2$cfsuffix \
	$COMIN/$cyc/pgrb2blr/ge$member.$cycle.pgrb2bf$FH.2$cfsuffix.idx \
	$COMIN/$cyc/sfcsig/ge$member.$cycle.bf$FH$cfsuffix \
	$COMIN/$cyc/sfcsig/ge$member.$cycle.sf$FH$cfsuffix \
	$COMIN/$cyc/sflux/ge$member.$cycle.sfluxgrbf$FH$cfsuffix \
      "
      if (( FH > 0 )) && (( FH <= fhmaxh )); then
	(( FP = FH - 3 ))
#Note by Dingchen, need to consider pgrb2a/2b files at 3, 9, 15 .. hours
	if (( FP < 10 )); then
	  FP=0$FP
	fi
	filelist="$filelist
	  $COMIN/$cyc/sfcsig/ge$member.$cycle.bf$FP$cfsuffix \
	  $COMIN/$cyc/sfcsig/ge$member.$cycle.sf$FP$cfsuffix \
	  $COMIN/$cyc/sflux/ge$member.$cycle.sfluxgrbf$FP$cfsuffix \
	"
      fi
      for file in $filelist
      do
	if [[ ! -s $file ]]; then
	  (( nmissing = nmissing + 1 ))
	  echo nmissing=$nmissing file=$file IS MISSING
	fi
      done

      (( FH = FH + FHINC ))
      if (( FH < 10 )); then
	FH=0$FH
      fi
    done
  done
done
echo nmissing=$nmissing
echo `date` GRIB file test before cleanup end
if (( nmissing > 0 )); then
  echo `date` GRIB file test before cleanup IDENTIFIED $nmissing MISSING FILES
  exit 99
else
  echo `date` sfcsig sflux cleanup end
  for cyc_check in 00 06 12 18
  do

    echo cyc=$cyc cyc_check=$cyc_check

    if (( cyc == cyc_check )); then
      export fcstlong=true
      export cfsuffix=""
      export cycsuffix=false
      memberlisttest="$memberlist c00"
    else
      export fcstlong=false
      export cfsuffix=".cycfs$cyc_check"
      export cycsuffix=true
      memberlisttest="$memberlist"
    fi

    for member in $memberlisttest
    do

      ####################################
      # Specify the Ensemble Member
      ####################################
      export RUN=ge${member}

      export PS4=' + $SECONDS $na $RUN R $LINENO: '

      ####################################
      # Specify Forecast Hour Range
      ####################################
      export FHINC=06

      export SHOUR=00

      if [[ $fcstlong = true ]]; then
	if [[ x$HOUTSPS = x ]]; then
	  export FHOUR=$fhmax
	else
	(( FHOUR = fhmax - HOUTSPS - FHINC ))
	fi       
	if (( FHOUR < 10 )); then
	  FHOUR=0$FHOUR
	fi
	export FHOUR
      else
	export FHOUR=06
      fi

      ###########################################################
      # remove sigma, surface, and flux files
      ###########################################################
      $HOMEgefs/scripts/exgefs_post_cleanup.sh.sms
    done
  done
  echo `date` sfcsig sflux cleanup end
  ########################################################
  # remove master post subdirectory
  ########################################################
  echo `date` before master cleanup
  rm -rf $COMIN/$cyc/master
  echo `date` after master cleanup
fi
########################################################
export PS4=' + $SECONDS $na $LINENO: '

##############################
# Remove the Temporary working directory
##############################
cd $DATAROOT
rm -rf $DATA

echo `date` $0 `date -u` end
